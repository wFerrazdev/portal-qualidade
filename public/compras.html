<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras | Portal da Qualidade</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="style.css">
    <script src="auth0-config.js"></script>
</head>
<body class="unauthenticated compras-page">
    <div class="page-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="GT Branco - Transparente.png" alt="GT Logo" class="sidebar-logo-img">
                <h2>Portal da Qualidade</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                        <span>Dashboard</span>
                    </a></li>
                    <li><a href="projetos.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Projetos</span>
                    </a></li>
                    <li><a href="reunioes.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>Reuniões</span>
                    </a></li>
                    <li><a href="auditoriasevisitas.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>Auditorias</span>
                    </a></li>
                    <li><a href="calibracao.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Calibração</span>
                    </a></li>
                    <li><a href="compras.html" class="nav-item active">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                        <span>Compras</span>
                    </a></li>
                    <li><a href="login.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span>Sair</span>
                    </a></li>
                </ul>
            </nav>
            <div class="user-info">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span>Logado como: Will</span>
            </div>
            <div class="sidebar-footer-logo">
                <img src="logo.png" alt="Logo" class="footer-logo">
            </div>
        </aside>

        <div class="overlay" id="overlay"></div>

        <!-- <div class="main-content"> -->
            <header class="content-header">
                <!-- Ondas animadas integradas no content-header -->
                <svg class="projects-wave wave-1" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q100,20 200,100 Q300,180 400,100 Q500,20 600,100 Q700,180 800,100 Q900,20 1000,100 Q1100,180 1200,100" stroke="#60a5fa" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-2" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q150,30 300,100 Q450,170 600,100 Q750,30 900,100 Q1050,170 1200,100" stroke="#93c5fd" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-3" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q200,40 400,100 Q600,160 800,100 Q1000,40 1200,100" stroke="#3b82f6" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-4" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q120,10 240,100 Q360,190 480,100 Q600,10 720,100 Q840,190 960,100 Q1080,10 1200,100" stroke="#1d4ed8" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-5" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q180,50 360,100 Q540,150 720,100 Q900,50 1080,100 Q1200,100 1200,100" stroke="#0ea5e9" stroke-width="2" fill="none" />
                    </svg>

                <!-- Partículas flutuantes integradas no content-header. -->
                <div class="projects-particle straight" style="top: 100%; left: 10%; animation-delay: 0s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 80%; animation-delay: 0.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 20%; animation-delay: 1s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 90%; animation-delay: 1.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 30%; animation-delay: 2s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 70%; animation-delay: 2.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 40%; animation-delay: 3s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 60%; animation-delay: 3.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 50%; animation-delay: 4s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 15%; animation-delay: 4.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 85%; animation-delay: 5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 25%; animation-delay: 5.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 75%; animation-delay: 6s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 35%; animation-delay: 6.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 65%; animation-delay: 7s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 45%; animation-delay: 7.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 55%; animation-delay: 8s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 5%; animation-delay: 8.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 95%; animation-delay: 9s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 12%; animation-delay: 9.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 88%; animation-delay: 10s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 22%; animation-delay: 10.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 78%; animation-delay: 11s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 32%; animation-delay: 11.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 68%; animation-delay: 12s;"></div>
                
                <div class="projects-header">
                    <div class="header-left">
                        <h1 class="projects-title">Pedidos de Compras</h1>
                        <p class="projects-subtitle">Sistema de gestão de pedidos e solicitações de compra</p>
                    </div>

                    <button id="nova-solicitacao-btn" class="btn-nova-solicitacao">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Nova Solicitação
                    </button>
                </div>
            </header>

            <main class="content-area">
                <!-- Loading state -->
                <div id="loading-state" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Carregando sistema de gestão...</p>
                </div>
                    
                <!-- Main App Content. (hidden initially) -->
                <div id="app-content" class="app-content" style="display: none;">
                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Total de Pedidos</p>
                                        <p class="stat-value" id="total-pedidos">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                        </svg>
                                    </div>
                    </div>
                </div>

                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Aguardando</p>
                                        <p class="stat-value" id="aguardando-count">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12,6 12,12 16,14"></polyline>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Em Andamento</p>
                                        <p class="stat-value" id="andamento-count">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"></polyline>
                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Concluídos</p>
                                        <p class="stat-value" id="concluidos-count">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22,4 12,14.01 9,11.01"></polyline>
                                </svg>
                                    </div>
                        </div>
                    </div>
                </div>

                        <!-- Filters -->
                        <div class="filters-section">
                            <div class="search-container">
                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                                <input type="text" id="search-input" placeholder="Buscar por número, descrição ou fornecedor..." class="search-input">
                            </div>
                            <div class="filter-container">
                                <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"></polygon>
                                </svg>
                                <select id="status-filter" class="status-filter">
                                    <option value="TODOS">Todos os Status</option>
                                </select>
                            </div>
        </div>

                        <!-- Orders Table -->
                        <div class="orders-table-container">
                            <div class="orders-table-wrapper">
                                <table class="orders-table">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Descrição</th>
                                        <th>Fornecedor</th>
                                        <th>Valor</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-tbody">
                                    <!-- Orders will be populated here -->
                                </tbody>
                            </table>
                            </div>
                            <div id="empty-state" class="empty-state" style="display: none;">
                                <div class="empty-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                    </svg>
                                </div>
                                <p>Nenhum pedido encontrado</p>
                            </div>
                        </div>
                        
                        <!-- Sistema de Paginação -->
                        <div id="pagination-container" class="pagination-container" style="display: none;">
                            <button id="prev-page" class="pagination-btn" onclick="window.gestaoComprasApp.previousPage()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <div id="page-numbers"></div>
                            <button id="next-page" class="pagination-btn" onclick="window.gestaoComprasApp.nextPage()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

    <footer class="footer">
        <p>&copy; 2025 - Developed by William Ferraz</p>
    </footer>

    <script type="module">
        // Função ajudante para fazer chamadas autenticadas
        async function authFetch(url, options = {}) {
            // Usar a função authenticatedFetch do auth0-config.js
            return await authenticatedFetch(url, options);
        }
        // Verificação de autenticação
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const user = await checkAuth();
                if (!user) {
                    window.location.href = '/login.html';
                    return;
                }
            } catch (error) {
                console.error('Erro na verificação de autenticação:', error);
                window.location.href = '/login.html';
            }
        });

        // --- LÓGICA PARA EXIBIR NOME DO USUÁRIO ---
        // Exibir informações do usuário autenticado via Auth0
        checkAuth().then(user => {
            if (user) {
                const userInfoSpan = document.querySelector('.user-info span');
                const userName = user.name || user.email;
                if (userInfoSpan) {
                    userInfoSpan.innerHTML = `Logado como: <strong>${userName}</strong>`;
                }
            }
        }).catch(error => {
            console.error('Erro ao obter informações do usuário:', error);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // --- LÓGICA DO MENU ---
            const body = document.body;
            const sidebar = document.querySelector('.sidebar');
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const overlay = document.getElementById('overlay');
            function openMenu() { body.classList.add('menu-open'); sidebar.classList.add('mobile-nav-open'); overlay.classList.add('active'); }
            function closeMenu() { body.classList.remove('menu-open'); sidebar.classList.remove('mobile-nav-open'); overlay.classList.remove('active'); }
            if (mobileMenuButton) { mobileMenuButton.addEventListener('click', openMenu); }
            if (overlay) { overlay.addEventListener('click', closeMenu); }
            window.addEventListener('load', () => { if (sidebar) { sidebar.classList.remove('preload'); } });
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => { 
                    e.preventDefault();
                    logout(); // Função definida em auth0-config.js
                });
            }
            
            // --- LÓGICA DE PERMISSÕES (VISUAL) ---
            // Verificar permissões do usuário autenticado
            checkAuth().then(user => {
                if (user) {
                    // Aqui você pode implementar lógica de permissões baseada no Auth0
                    // Por exemplo, verificar roles ou claims do usuário
                    const userRoles = user['https://portalqualidade.com/roles'] || [];
                    // Se o usuário NÃO tiver a permissão 'admin' na sua lista de permissões...
                    if (!userRoles.includes('admin')) {
                        // ...encontra e esconde todos os botões de ação.
                        const addBtn = document.querySelector('.add-button');
                        if (addBtn) addBtn.style.display = 'none';

                        // Também esconde os botões de editar/excluir que são criados dinamicamente
                        // Adicionando uma classe ao container principal para o CSS esconder os botões
                        const grid = document.querySelector('.projects-grid, .audits-grid, .meetings-list');
                        if(grid) grid.classList.add('viewer-mode');
                    }
                }
            }).catch(error => {
                console.error('Erro ao verificar permissões:', error);
            });
            

        });

        // --- LÓGICA DO MENU LATERAL ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                
                if (mobileMenuButton) {
                    mobileMenuButton.classList.toggle('active');
                }
            }
        }

        // Event listeners para o menu lateral..
        const mobileMenuButton = document.getElementById('mobileMenuButton');
            const overlay = document.getElementById('overlay');

            if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', toggleSidebar);
        }
        
        if (overlay) {
            overlay.addEventListener('click', toggleSidebar);
        }

        // --- SISTEMA DE GESTÃO DE COMPRAS ---
        class GestaoComprasApp {
            constructor() {
                this.orders = [];
                this.filteredOrders = [];
                this.searchTerm = '';
                this.statusFilter = 'TODOS';
                this.showModal = false;
                this.showDetailModalFlag = false;
                this.showEditModalFlag = false;
                this.selectedOrder = null;
                this.editData = {};
                
                // Propriedades de paginação
                this.currentPage = 1;
                this.ordersPerPage = 5;
                this.totalPages = 1;
                this.newOrder = {
                    descricao: '',
                    fornecedor: '',
                    valor: '',
                    observacoes: ''
                };

                this.STATUSES = {
                    AGUARDANDO_APROVACAO_SC: { label: 'Aguardando Aprovação SC', color: 'bg-amber-50 text-amber-700 border-amber-200' },
                    SC_APROVADA: { label: 'SC Aprovada', color: 'bg-blue-50 text-blue-700 border-blue-200' },
                    AGUARDANDO_APROVACAO_OC: { label: 'Aguardando Aprovação OC', color: 'bg-orange-50 text-orange-700 border-orange-200' },
                    OC_APROVADA: { label: 'OC Aprovada', color: 'bg-indigo-50 text-indigo-700 border-indigo-200' },
                    PEDIDO_EMITIDO: { label: 'Pedido Emitido', color: 'bg-purple-50 text-purple-700 border-purple-200' },
                    AGUARDANDO_PAGAMENTO: { label: 'Aguardando Pagamento', color: 'bg-yellow-50 text-yellow-700 border-yellow-200' },
                    PAGO: { label: 'Pago', color: 'bg-green-50 text-green-700 border-green-200' },
                    AGUARDANDO_ENTREGA: { label: 'Aguardando Entrega', color: 'bg-cyan-50 text-cyan-700 border-cyan-200' },
                    ENTREGUE: { label: 'Entregue', color: 'bg-emerald-50 text-emerald-700 border-emerald-200' },
                    REJEITADO: { label: 'Rejeitado', color: 'bg-red-50 text-red-700 border-red-200' },
                    CANCELADO: { label: 'Cancelado', color: 'bg-gray-50 text-gray-700 border-gray-200' },
                    // Status simplificados (fallback)
                    AGUARDANDO_APROVACAO: { label: 'Aguardando Aprovação', color: 'bg-amber-50 text-amber-700 border-amber-200' },
                    APROVADO: { label: 'Aprovado', color: 'bg-green-50 text-green-700 border-green-200' },
                    EM_ANALISE: { label: 'Em Análise', color: 'bg-yellow-50 text-yellow-700 border-yellow-200' },
                    CONCLUIDO: { label: 'Concluído', color: 'bg-emerald-50 text-emerald-700 border-emerald-200' }
                };

                this.init();
            }

            async init() {
                try {
                    await this.loadOrders();
                    this.setupEventListeners();
                    this.populateStatusFilter();
                    this.updateStats();
                    this.renderOrders();
                    this.hideLoading();
                } catch (error) {
                    console.error('Erro ao inicializar app:', error);
                    this.hideLoading();
                }
            }

            hideLoading() {
                const loadingState = document.getElementById('loading-state');
                const appContent = document.getElementById('app-content');
                if (loadingState) loadingState.style.display = 'none';
                if (appContent) appContent.style.display = 'block';
            }

            async loadOrders() {
                try {
                    console.log('🔄 Carregando pedidos...');
                    // Buscar pedidos da API consolidada
                    const response = await fetch('/api/compras');
                    console.log('📡 Resposta da API:', response.status, response.statusText);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ Dados recebidos da API:', data);
                        console.log('🔍 Verificando campo status no primeiro pedido:', data[0] ? {
                            id: data[0].id,
                            numero: data[0].numero,
                            status: data[0].status,
                            todosOsCampos: Object.keys(data[0])
                        } : 'Nenhum pedido');
                        
                        // Buscar histórico para cada pedido
                        for (const order of data) {
                            const historyResponse = await fetch(`/api/compras?action=history&numero=${order.numero}`);
                            if (historyResponse.ok) {
                                const history = await historyResponse.json();
                                order.historico = history.map(h => ({
                                    data: h.data_mudanca,
                                    status: h.status_novo,
                                    observacao: h.observacao
                                }));
                            } else {
                                order.historico = [];
                            }
                        }
                        
                        this.orders = data;
                    } else {
                        console.log('❌ API não disponível, usando localStorage');
                        // Fallback para localStorage se API não estiver disponível
                        const storedOrders = localStorage.getItem('gestao-compras-orders');
                        if (storedOrders) {
                            this.orders = JSON.parse(storedOrders);
                            console.log('💾 Dados carregados do localStorage:', this.orders);
                        } else {
                            // Dados de exemplo
                            this.orders = [
                                {
                                    numero: 1001,
                                    descricao: 'Equipamentos de laboratório',
                                    fornecedor: 'LabTech Solutions',
                                    valor: 15000.00,
                                    status: 'AGUARDANDO_APROVACAO_SC',
                                    dataCriacao: new Date().toISOString(),
                                    observacoes: 'Equipamentos para novo laboratório',
                                    historico: [{
                                        data: new Date().toISOString(),
                                        status: 'AGUARDANDO_APROVACAO_SC',
                                        observacao: 'Solicitação de compra criada pelo setor de Qualidade'
                                    }]
                                },
                                {
                                    numero: 1002,
                                    descricao: 'Material de consumo',
                                    fornecedor: 'SupplyCorp',
                                    valor: 2500.00,
                                    status: 'SC_APROVADA',
                                    dataCriacao: new Date(Date.now() - 86400000).toISOString(),
                                    observacoes: 'Material para testes de qualidade',
                                    historico: [
                                        {
                                            data: new Date(Date.now() - 86400000).toISOString(),
                                            status: 'AGUARDANDO_APROVACAO_SC',
                                            observacao: 'Solicitação de compra criada pelo setor de Qualidade'
                                        },
                                        {
                                            data: new Date().toISOString(),
                                            status: 'SC_APROVADA',
                                            observacao: 'Aprovado pelo Supervisor de Compras'
                                        }
                                    ]
                                }
                            ];
                        }
                        // Salvar no localStorage como backup
                        this.saveOrders();
                    }
                    this.filteredOrders = [...this.orders];
                } catch (error) {
                    console.error('Erro ao carregar pedidos:', error);
                    // Tentar carregar do localStorage em caso de erro
                    const storedOrders = localStorage.getItem('gestao-compras-orders');
                    if (storedOrders) {
                        this.orders = JSON.parse(storedOrders);
                        this.filteredOrders = [...this.orders];
                    } else {
                        this.orders = [];
                        this.filteredOrders = [];
                    }
                }
            }

            async saveOrders() {
                // Salvar no localStorage como backup
                localStorage.setItem('gestao-compras-orders', JSON.stringify(this.orders));
            }

            setupEventListeners() {
                // Nova solicitação
                const novaSolicitacaoBtn = document.getElementById('nova-solicitacao-btn');
                if (novaSolicitacaoBtn) {
                    novaSolicitacaoBtn.addEventListener('click', () => this.showCreateModal());
                }

                // Search
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value;
                        this.filterOrders();
                    });
                }

                // Status filter
                const statusFilter = document.getElementById('status-filter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', (e) => {
                        this.statusFilter = e.target.value;
                        this.filterOrders();
                    });
                }
            }

            populateStatusFilter() {
                const statusFilter = document.getElementById('status-filter');
                if (!statusFilter) return;

                // Limpar opções existentes (exceto "Todos os Status")
                while (statusFilter.children.length > 1) {
                    statusFilter.removeChild(statusFilter.lastChild);
                }

                // Adicionar opções de status
                Object.keys(this.STATUSES).forEach(status => {
                    const count = this.orders.filter(o => o.status === status).length;
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = `${this.STATUSES[status].label} (${count})`;
                    statusFilter.appendChild(option);
                });
            }

            filterOrders() {
                let filtered = [...this.orders];

                if (this.searchTerm) {
                    filtered = filtered.filter(order => 
                        order.numero.toString().includes(this.searchTerm) ||
                        order.descricao.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        order.fornecedor.toLowerCase().includes(this.searchTerm.toLowerCase())
                    );
                }

                if (this.statusFilter !== 'TODOS') {
                    filtered = filtered.filter(order => order.status === this.statusFilter);
                }

                this.filteredOrders = filtered;
                
                // Resetar para primeira página quando filtrar
                this.currentPage = 1;
                
                this.updateStats();
                this.renderOrders();
            }

            updateStats() {
                const totalPedidos = document.getElementById('total-pedidos');
                const aguardandoCount = document.getElementById('aguardando-count');
                const andamentoCount = document.getElementById('andamento-count');
                const concluidosCount = document.getElementById('concluidos-count');

                if (totalPedidos) totalPedidos.textContent = this.orders.length;

                const aguardando = this.orders.filter(o => 
                    ['AGUARDANDO_APROVACAO_SC', 'AGUARDANDO_APROVACAO_OC', 'AGUARDANDO_PAGAMENTO', 'AGUARDANDO_ENTREGA'].includes(o.status)
                ).length;
                if (aguardandoCount) aguardandoCount.textContent = aguardando;

                const andamento = this.orders.filter(o => 
                    ['SC_APROVADA', 'OC_APROVADA', 'PEDIDO_EMITIDO', 'PAGO'].includes(o.status)
                ).length;
                if (andamentoCount) andamentoCount.textContent = andamento;

                const concluidos = this.orders.filter(o => o.status === 'ENTREGUE').length;
                if (concluidosCount) concluidosCount.textContent = concluidos;
            }

            renderOrders() {
                const tbody = document.getElementById('orders-tbody');
                const emptyState = document.getElementById('empty-state');
                const paginationContainer = document.getElementById('pagination-container');
                
                if (!tbody) return;

                tbody.innerHTML = '';

                if (this.filteredOrders.length === 0) {
                    if (emptyState) emptyState.style.display = 'block';
                    if (paginationContainer) paginationContainer.style.display = 'none';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';

                // Calcular paginação
                this.totalPages = Math.ceil(this.filteredOrders.length / this.ordersPerPage);
                const startIndex = (this.currentPage - 1) * this.ordersPerPage;
                const endIndex = startIndex + this.ordersPerPage;
                const ordersToShow = this.filteredOrders.slice(startIndex, endIndex);

                // Mostrar/ocultar paginação
                if (this.totalPages > 1) {
                    if (paginationContainer) paginationContainer.style.display = 'flex';
                    this.renderPagination();
                } else {
                    if (paginationContainer) paginationContainer.style.display = 'none';
                }

                ordersToShow.forEach((order, idx) => {
                    const row = document.createElement('tr');
                    row.style.cssText = 'transition: all 0.2s ease;';
                    row.onmouseover = () => row.style.backgroundColor = '#f8fafc';
                    row.onmouseout = () => row.style.backgroundColor = 'transparent';
                    
                    row.innerHTML = `
                        <td style="padding: 1rem 1.5rem; white-space: nowrap;">
                            <span style="font-size: 0.875rem; font-weight: 700; color: #2563eb;">${order.numero}</span>
                        </td>
                        <td style="padding: 1rem 1.5rem;">
                            <div style="font-size: 0.875rem; font-weight: 500; color: #1e293b;">${order.descricao}</div>
                            ${order.fornecedor ? `<div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">${order.fornecedor}</div>` : ''}
                        </td>
                        <td style="padding: 1rem 1.5rem; white-space: nowrap;">
                            <span style="font-size: 0.875rem; color: #374151;">${order.quantidade || 'N/A'}</span>
                        </td>
                        <td style="padding: 1rem 1.5rem; white-space: nowrap;">
                            <span style="font-size: 0.875rem; font-weight: 500; color: #059669;">${this.formatCurrency(order.valor)}</span>
                        </td>
                        <td style="padding: 1rem 1.5rem; white-space: nowrap;">
                            <span style="font-size: 0.875rem; color: #374151;">${this.formatDate(order.data_criacao)}</span>
                        </td>
                        <td style="padding: 1rem 1.5rem; white-space: nowrap;">
                            ${this.getStatusBadge(order.status)}
                            ${order.last_change ? `
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    Atualizado em ${this.formatDate(order.last_change)}${order.last_user ? ` por ${order.last_user}` : ''}
                                </div>
                            ` : ''}
                        </td>
                        <td style="padding: 1rem 1.5rem; white-space: nowrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <!-- Botão Visualizar -->
                                <button onclick="window.gestaoComprasApp.openDetailModal('${order.numero}')" 
                                        style="width: 32px; height: 32px; background: #2563eb; color: white; border: none; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                        onmouseover="this.style.background='#1d4ed8'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                                        onmouseout="this.style.background='#2563eb'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                                
                                <!-- Botão Excluir -->
                                <button onclick="window.gestaoComprasApp.deleteOrder(${order.id})" 
                                        style="width: 32px; height: 32px; background: #dc2626; color: white; border: none; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                        onmouseover="this.style.background='#b91c1c'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                                        onmouseout="this.style.background='#dc2626'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            showCreateModal() {
                this.showModal = true;
                this.renderModals();
            }

            openDetailModal(orderNumber) {
                const order = this.orders.find(o => o.numero?.toString() === orderNumber?.toString());
                if (!order) return;

                this.selectedOrder = order;
                this.showDetailModalFlag = true;
                this.renderModals();
            }

            openEditModal(orderId) {
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return;
                this.selectedOrder = order;
                this.editData = { ...order };
                this.showEditModalFlag = true;
                this.renderModals();
            }

            cancelEdit() {
                this.showEditModalFlag = false;
                this.renderModals();
            }

            async saveEdit() {
                if (!this.selectedOrder) return;
                const updated = {
                    ...this.selectedOrder,
                    numero: (document.getElementById('edit-numero')?.value || '').trim() || this.selectedOrder.numero,
                    solicitante: document.getElementById('edit-solicitante')?.value || this.selectedOrder.solicitante,
                    descricao: document.getElementById('edit-descricao')?.value || this.selectedOrder.descricao,
                    fornecedor: document.getElementById('edit-fornecedor')?.value || this.selectedOrder.fornecedor,
                    quantidade: parseInt(document.getElementById('edit-quantidade')?.value || this.selectedOrder.quantidade || 0, 10) || this.selectedOrder.quantidade,
                    valor: parseFloat(document.getElementById('edit-valor')?.value || this.selectedOrder.valor) || this.selectedOrder.valor,
                    observacoes: document.getElementById('edit-observacoes')?.value || this.selectedOrder.observacoes
                };

                try {
                    const response = await fetch(`/api/compras?id=${this.selectedOrder.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            numero: updated.numero,
                            solicitante: updated.solicitante,
                            descricao: updated.descricao,
                            fornecedor: updated.fornecedor,
                            quantidade: updated.quantidade,
                            valor: updated.valor,
                            observacoes: updated.observacoes
                        })
                    });

                    if (response.ok) {
                        this.orders = this.orders.map(o => o.id === this.selectedOrder.id ? updated : o);
                        this.filterOrders();
                        this.showEditModalFlag = false;
                        this.renderModals();
                    } else {
                        this.orders = this.orders.map(o => o.id === this.selectedOrder.id ? updated : o);
                        this.saveOrders();
                        this.filterOrders();
                        this.showEditModalFlag = false;
                        this.renderModals();
                    }
                } catch (e) {
                    this.orders = this.orders.map(o => o.id === this.selectedOrder.id ? updated : o);
                    this.saveOrders();
                    this.filterOrders();
                    this.showEditModalFlag = false;
                    this.renderModals();
                }
            }

            closeModals() {
                this.showModal = false;
                this.showDetailModalFlag = false;
                this.showEditModalFlag = false;
                this.renderModals();
            }

            async deleteOrder(orderId) {
                if (!confirm('Tem certeza que deseja excluir este pedido?')) return;
                
                try {
                    const response = await fetch(`/api/compras?id=${orderId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.orders = this.orders.filter(o => o.id !== orderId);
                        this.filterOrders();
                        this.updateStats();
                        this.closeModals();
                    } else {
                        throw new Error('Falha ao excluir pedido');
                    }
                } catch (error) {
                    console.error('Erro ao excluir pedido:', error);
                    alert('Erro ao excluir pedido');
                }
            }

            async regressStage(orderId) {
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return;
                
                const previousStatusMap = {
                    // Fluxo completo (9 etapas)
                    'SC_APROVADA': 'AGUARDANDO_APROVACAO_SC',
                    'AGUARDANDO_APROVACAO_OC': 'SC_APROVADA',
                    'OC_APROVADA': 'AGUARDANDO_APROVACAO_OC',
                    'PEDIDO_EMITIDO': 'OC_APROVADA',
                    'AGUARDANDO_PAGAMENTO': 'PEDIDO_EMITIDO',
                    'PAGO': 'AGUARDANDO_PAGAMENTO',
                    'AGUARDANDO_ENTREGA': 'PAGO',
                    'ENTREGUE': 'AGUARDANDO_ENTREGA',
                    
                    // Status simplificados
                    'APROVADO': 'EM_ANALISE',
                    'CONCLUIDO': 'APROVADO'
                };
                
                const newStatus = previousStatusMap[order.status];
                
                if (!newStatus) return; // Não há status anterior válido
                
                // Atualização otimista: atualizar UI imediatamente
                order.status = newStatus;
                this.renderOrders();
                
                // Atualizar no banco de dados
                await this.updateOrderStatus(order, newStatus, `Regressado para ${this.STATUSES[newStatus].label}`);
            }

            async advanceStage(orderId) {
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return;
                
                const stageMap = {
                    1: 'AGUARDANDO_APROVACAO_SC',
                    2: 'SC_APROVADA',
                    3: 'AGUARDANDO_APROVACAO_OC',
                    4: 'OC_APROVADA',
                    5: 'PEDIDO_EMITIDO',
                    6: 'AGUARDANDO_PAGAMENTO',
                    7: 'PAGO',
                    8: 'AGUARDANDO_ENTREGA',
                    9: 'ENTREGUE'
                };
                
                const currentStage = this.getCurrentStage(order.status);
                const nextStage = currentStage + 1;
                
                if (nextStage > 9) return;
                
                const newStatus = stageMap[nextStage];
                
                // Atualização otimista: atualizar UI imediatamente
                order.status = newStatus;
                this.renderOrders();
                
                // Atualizar no banco de dados
                await this.updateOrderStatus(order, newStatus, `Avançado para ${this.STATUSES[newStatus].label}`);
            }

            getStatusBadge(status) {
                const statusConfig = {
                    'AGUARDANDO_APROVACAO_SC': {
                        label: 'Aguardando Aprovação SC',
                        icon: 'clock',
                        bgColor: '#fef3c7',
                        textColor: '#92400e',
                        borderColor: '#f59e0b'
                    },
                    'SC_APROVADA': {
                        label: 'SC Aprovada',
                        icon: 'check',
                        bgColor: '#dcfce7',
                        textColor: '#166534',
                        borderColor: '#22c55e'
                    },
                    'AGUARDANDO_APROVACAO_OC': {
                        label: 'Aguardando Aprovação OC',
                        icon: 'clock',
                        bgColor: '#fef3c7',
                        textColor: '#92400e',
                        borderColor: '#f59e0b'
                    },
                    'OC_APROVADA': {
                        label: 'OC Aprovada',
                        icon: 'check',
                        bgColor: '#dcfce7',
                        textColor: '#166534',
                        borderColor: '#22c55e'
                    },
                    'PEDIDO_EMITIDO': {
                        label: 'Pedido Emitido',
                        icon: 'package',
                        bgColor: '#e9d5ff',
                        textColor: '#7c3aed',
                        borderColor: '#a855f7'
                    },
                    'AGUARDANDO_PAGAMENTO': {
                        label: 'Aguardando Pagamento',
                        icon: 'dollar',
                        bgColor: '#fed7aa',
                        textColor: '#c2410c',
                        borderColor: '#fb923c'
                    },
                    'PAGO': {
                        label: 'Pago',
                        icon: 'check',
                        bgColor: '#dcfce7',
                        textColor: '#166534',
                        borderColor: '#22c55e'
                    },
                    'AGUARDANDO_ENTREGA': {
                        label: 'Aguardando Entrega',
                        icon: 'truck',
                        bgColor: '#e0e7ff',
                        textColor: '#3730a3',
                        borderColor: '#6366f1'
                    },
                    'ENTREGUE': {
                        label: 'Entregue',
                        icon: 'check-circle',
                        bgColor: '#d1fae5',
                        textColor: '#047857',
                        borderColor: '#10b981'
                    },
                    'REJEITADO': {
                        label: 'Rejeitado',
                        icon: 'x',
                        bgColor: '#fee2e2',
                        textColor: '#dc2626',
                        borderColor: '#ef4444'
                    },
                    'CANCELADO': {
                        label: 'Cancelado',
                        icon: 'x',
                        bgColor: '#f3f4f6',
                        textColor: '#6b7280',
                        borderColor: '#9ca3af'
                    },
                    'EM_ANALISE': {
                        label: 'Em Análise',
                        icon: 'clock',
                        bgColor: '#dbeafe',
                        textColor: '#1e40af',
                        borderColor: '#3b82f6'
                    },
                    'AGUARDANDO_APROVACAO': {
                        label: 'Aguardando Aprovação',
                        icon: 'clock',
                        bgColor: '#fef3c7',
                        textColor: '#92400e',
                        borderColor: '#f59e0b'
                    },
                    'APROVADO': {
                        label: 'Aprovado',
                        icon: 'check',
                        bgColor: '#dcfce7',
                        textColor: '#166534',
                        borderColor: '#22c55e'
                    },
                    'CONCLUIDO': {
                        label: 'Concluído',
                        icon: 'check-circle',
                        bgColor: '#d1fae5',
                        textColor: '#047857',
                        borderColor: '#10b981'
                    }
                };

                const config = statusConfig[status] || statusConfig['AGUARDANDO_APROVACAO_SC'];
                
                const iconMap = {
                    'clock': 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                    'check': 'M5 13l4 4L19 7',
                    'package': 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4',
                    'dollar': 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1',
                    'truck': 'M1 3h15v13H1zM16 8h4l3 3v5h-7V8z',
                    'check-circle': 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
                    'x': 'M6 18L18 6M6 6l12 12'
                };

                return `
                    <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; border: 1px solid ${config.borderColor}; background-color: ${config.bgColor}; color: ${config.textColor};">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconMap[config.icon]}"></path>
                        </svg>
                        <span>${config.label}</span>
                    </div>
                `;
            }

            getCurrentStage(status) {
                const statusToStage = {
                    'AGUARDANDO_APROVACAO_SC': 1,
                    'SC_APROVADA': 2,
                    'AGUARDANDO_APROVACAO_OC': 3,
                    'OC_APROVADA': 4,
                    'PEDIDO_EMITIDO': 5,
                    'AGUARDANDO_PAGAMENTO': 6,
                    'PAGO': 7,
                    'AGUARDANDO_ENTREGA': 8,
                    'ENTREGUE': 9,
                    'REJEITADO': 2,
                    'CANCELADO': 2,
                    // Status simplificados (fallback)
                    'AGUARDANDO_APROVACAO': 1,
                    'APROVADO': 2,
                    'EM_ANALISE': 3,
                    'CONCLUIDO': 4
                };
                return statusToStage[status] || 1;
            }

            renderModals() {
                // Remove modals existentes
                const existingModals = document.querySelectorAll('.modal-overlay');
                existingModals.forEach(modal => modal.remove());

                // Modal de criação
                if (this.showModal) {
                    const modalHTML = `
                        <div class="modal-overlay" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem;">
                            <div class="modal-content" style="background: white; border-radius: 1rem; max-width: 32rem; width: 100%; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                                <div style="margin-bottom: 1.5rem;">
                                    <h2 style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #6366f1 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 0.25rem 0;">
                                        Nova Solicitação de Compra
                                    </h2>
                                    <p style="font-size: 0.875rem; color: #64748b; margin: 0;">Preencha os dados para criar uma nova solicitação</p>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            N° da Solicitação (ID)
                                        </label>
                                        <input type="text" id="modal-numero" 
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="Ex: SC-001 (opcional)">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Setor Responsável *</label>
                                        <select id="modal-solicitante" 
                                                style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; background: #f8fafc;">
                                            <option value="Qualidade">Qualidade</option>
                                            <option value="Produção">Produção</option>
                                            <option value="Manutenção">Manutenção</option>
                                            <option value="Logística">Logística</option>
                                            <option value="Administração">Administração</option>
                                            <option value="Engenharia">Engenharia</option>
                                            <option value="Comercial">Comercial</option>
                                            <option value="TI">TI</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Descrição do Item/Serviço *
                                        </label>
                                        <input type="text" id="modal-descricao" value="${this.newOrder.descricao}" 
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="Ex: Material de laboratório, equipamento, etc.">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Fornecedor *
                                        </label>
                                        <input type="text" id="modal-fornecedor" value="${this.newOrder.fornecedor}" 
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="Nome do fornecedor">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Valor Estimado (R$) *
                                        </label>
                                        <input type="number" id="modal-valor" value="${this.newOrder.valor}" step="0.01" min="0"
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="0.00">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Quantidade *
                                        </label>
                                        <input type="number" id="modal-quantidade" value="${this.newOrder.quantidade || ''}" min="1"
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="0">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Observações
                                        </label>
                                        <textarea id="modal-observacoes" rows="3" 
                                                  style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease; resize: vertical;"
                                                  placeholder="Informações adicionais...">${this.newOrder.observacoes}</textarea>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                    <button onclick="window.gestaoComprasApp.handleCreateOrder()" 
                                            style="flex: 1; background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);">
                                        Criar Solicitação
                                    </button>
                                    <button onclick="window.gestaoComprasApp.closeModals()" 
                                            style="flex: 1; background: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }

                // Modal de visualização moderno
                if (this.showDetailModalFlag && this.selectedOrder) {
                    const order = this.selectedOrder;
                    
                    // Definir estágios do pedido
                    const stages = [
                        { id: 1, name: 'Aguardando Aprovação SC', icon: 'clock' },
                        { id: 2, name: 'SC Aprovada', icon: 'check' },
                        { id: 3, name: 'Aguardando Aprovação OC', icon: 'clock' },
                        { id: 4, name: 'OC Aprovada', icon: 'check' },
                        { id: 5, name: 'Pedido Emitido', icon: 'document' },
                        { id: 6, name: 'Aguardando Pagamento', icon: 'clock' },
                        { id: 7, name: 'Pago', icon: 'check' },
                        { id: 8, name: 'Aguardando Entrega', icon: 'clock' },
                        { id: 9, name: 'Entregue', icon: 'check-circle' }
                    ];
                    
                    // Mapear status para estágio
                    const statusToStage = {
                        'AGUARDANDO_APROVACAO_SC': 1,
                        'SC_APROVADA': 2,
                        'AGUARDANDO_APROVACAO_OC': 3,
                        'OC_APROVADA': 4,
                        'PEDIDO_EMITIDO': 5,
                        'AGUARDANDO_PAGAMENTO': 6,
                        'PAGO': 7,
                        'AGUARDANDO_ENTREGA': 8,
                        'ENTREGUE': 9,
                        'REJEITADO': 2,
                        'CANCELADO': 2,
                        // Status simplificados (fallback)
                        'AGUARDANDO_APROVACAO': 1,
                        'APROVADO': 2,
                        'EM_ANALISE': 3,
                        'CONCLUIDO': 4
                    };
                    
                    const currentStage = statusToStage[order.status] || 1;
                    
                    const modalHTML = `
                        <div class="modal-overlay" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50;">
                            <div class="modal-content" style="background: white; border-radius: 1rem; max-width: 40rem; width: 100%; padding: 1.5rem; max-height: 85vh; overflow-y: auto; border: 1px solid #e2e8f0; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); scrollbar-width: thin; scrollbar-color: #3b82f6 #f1f5f9;">
                                <style>
                                    .modal-content::-webkit-scrollbar {
                                        width: 6px;
                                    }
                                    .modal-content::-webkit-scrollbar-track {
                                        background: transparent;
                                    }
                                    .modal-content::-webkit-scrollbar-thumb {
                                        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                                        border-radius: 3px;
                                        border: none;
                                        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
                                    }
                                    .modal-content::-webkit-scrollbar-thumb:hover {
                                        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                                        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
                                    }
                                    .modal-content::-webkit-scrollbar-thumb:active {
                                        background: linear-gradient(135deg, #1d4ed8 0%, #1e3a8a 100%);
                                    }
                                </style>
                                <!-- Header -->
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <h2 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #3b82f6;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                        Detalhes do Pedido
                                    </h2>
                                    <button onclick="window.gestaoComprasApp.closeModals()" 
                                            style="color: #64748b; background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: all 0.3s ease; hover:color: #475569;">
                                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>

                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    <!-- Informações principais -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 0.5rem; padding: 0.75rem; border: 2px solid #93c5fd;">
                                            <label style="font-size: 0.75rem; font-weight: 500; color: #475569; text-transform: uppercase; letter-spacing: 0.05em;">ID do Pedido</label>
                                            <p style="font-size: 1.125rem; font-weight: 700; color: #1d4ed8; margin: 0.25rem 0 0 0;">#${order.numero}</p>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-radius: 0.5rem; padding: 0.75rem; border: 2px solid #cbd5e1;">
                                            <label style="font-size: 0.75rem; font-weight: 500; color: #475569; text-transform: uppercase; letter-spacing: 0.05em;">Data</label>
                                            <p style="font-size: 1.125rem; font-weight: 700; color: #1e293b; margin: 0.25rem 0 0 0;">${this.formatDate(order.data_criacao)}</p>
                                        </div>
                                    </div>

                                    <!-- Item solicitado -->
                                    <div style="background: #f8fafc; border-radius: 0.5rem; padding: 0.75rem; border: 2px solid #e2e8f0;">
                                        <label style="font-size: 0.75rem; font-weight: 500; color: #475569; text-transform: uppercase; letter-spacing: 0.05em;">Item Solicitado</label>
                                        <p style="font-size: 1rem; font-weight: 600; color: #1e293b; margin: 0.25rem 0 0 0;">${order.descricao}</p>
                                    </div>

                                    <!-- Informações adicionais -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                                        <div style="background: #f8fafc; border-radius: 0.5rem; padding: 0.75rem; border: 2px solid #e2e8f0;">
                                            <label style="font-size: 0.75rem; font-weight: 500; color: #475569; text-transform: uppercase; letter-spacing: 0.05em;">Fornecedor</label>
                                            <p style="font-size: 1rem; font-weight: 700; color: #1e293b; margin: 0.25rem 0 0 0;">${order.fornecedor}</p>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 0.5rem; padding: 0.75rem; border: 2px solid #6ee7b7;">
                                            <label style="font-size: 0.75rem; font-weight: 500; color: #047857; text-transform: uppercase; letter-spacing: 0.05em;">Valor</label>
                                            <p style="font-size: 1rem; font-weight: 700; color: #065f46; margin: 0.25rem 0 0 0;">${this.formatCurrency(order.valor)}</p>
                                        </div>
                                        <div style="background: #f8fafc; border-radius: 0.5rem; padding: 0.75rem; border: 2px solid #e2e8f0;">
                                            <label style="font-size: 0.75rem; font-weight: 500; color: #475569; text-transform: uppercase; letter-spacing: 0.05em;">Solicitante</label>
                                            <p style="font-size: 1rem; font-weight: 700; color: #1e293b; margin: 0.25rem 0 0 0;">${order.solicitante || 'Qualidade'}</p>
                                        </div>
                                    </div>

                                    ${order.observacoes ? `
                                        <div style="background: #f8fafc; border-radius: 0.5rem; padding: 0.75rem; border: 2px solid #e2e8f0;">
                                            <label style="font-size: 0.75rem; font-weight: 500; color: #475569; text-transform: uppercase; letter-spacing: 0.05em;">Observações</label>
                                            <p style="font-size: 0.875rem; font-weight: 500; color: #1e293b; margin: 0.25rem 0 0 0;">${order.observacoes}</p>
                                        </div>
                                    ` : ''}

                                    <!-- Progresso do Pedido -->
                                    <div>
                                        <label style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.75rem; display: block;">Progresso do Pedido</label>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                            ${stages.map((stage) => {
                                                const isComplete = currentStage > stage.id;
                                                const isCurrent = currentStage === stage.id;
                                                const iconMap = {
                                                    'clock': 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                                                    'check': 'M5 13l4 4L19 7',
                                                    'search': 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z',
                                                    'check-circle': 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
                                                    'document': 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'
                                                };
                                                return `
                                                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; transition: all 0.3s ease; ${
                                                        isCurrent
                                                            ? 'background: #dbeafe; border: 2px solid #3b82f6;'
                                                            : isComplete
                                                            ? 'background: #d1fae5; border: 2px solid #10b981;'
                                                            : 'background: #f8fafc; border: 2px solid #e2e8f0;'
                                                    }">
                                                        <div style="flex-shrink: 0; color: ${
                                                            isCurrent ? '#3b82f6' : isComplete ? '#10b981' : '#9ca3af'
                                                        };">
                                                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconMap[stage.icon]}"></path>
                                                            </svg>
                                                        </div>
                                                        <span style="flex: 1; font-weight: 500; color: ${
                                                            isCurrent ? '#1d4ed8' : isComplete ? '#047857' : '#6b7280'
                                                        }; font-size: 0.875rem;">
                                                            ${stage.name}
                                                        </span>
                                                        ${isComplete ? `
                                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #10b981; flex-shrink: 0;">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                            </svg>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- Botões de ação -->
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e2e8f0; flex-wrap: wrap;">
                                    <button onclick="window.gestaoComprasApp.closeModals()" 
                                            style="flex: 1; padding: 0.625rem 1.25rem; background: #e2e8f0; border: 2px solid #cbd5e1; border-radius: 0.5rem; color: #475569; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem;">
                                        Fechar
                                    </button>

                                    <button onclick="window.gestaoComprasApp.openEditModal(${order.id})" 
                                            style="padding: 0.625rem 1.25rem; background: #2563eb; color: white; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Editar
                                    </button>
                                    
                                    <button onclick="window.gestaoComprasApp.deleteOrder(${order.id})" 
                                            style="padding: 0.625rem 1.25rem; background: #dc2626; color: white; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Excluir
                                    </button>
                                    
                                    ${currentStage > 1 ? `
                                        <button onclick="window.gestaoComprasApp.regressStage(${order.id})" 
                                                style="padding: 0.625rem 1.25rem; background: #ea580c; color: white; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                            </svg>
                                            Voltar
                                        </button>
                                    ` : ''}
                                    
                                    ${currentStage < 9 ? `
                                        <button onclick="window.gestaoComprasApp.advanceStage(${order.id})" 
                                                style="padding: 0.625rem 1.25rem; background: #059669; color: white; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Avançar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }

                // Modal de edição
                if (this.showEditModalFlag && this.selectedOrder) {
                    const e = this.editData || {};
                    const options = ['Qualidade','Produção','Manutenção','Logística','Administração','Engenharia','Comercial','TI'];
                    const modalHTML = `
                        <div class="modal-overlay" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50;">
                            <div class="modal-content" style="background: white; border-radius: 1rem; max-width: 40rem; width: 100%; padding: 1.5rem; max-height: 85vh; overflow-y: auto; border: 1px solid #e2e8f0; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
                                    <h2 style="font-size:1.25rem; font-weight:700; color:#1e293b; margin:0;">Editar Solicitação</h2>
                                    <button onclick="window.gestaoComprasApp.cancelEdit()" style="color:#64748b; background:none; border:none; cursor:pointer; padding:0.5rem; border-radius:0.5rem;">
                                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                <div style="display:flex; flex-direction:column; gap:1rem;">
                                    <div>
                                        <label style="display:block; font-size:0.75rem; font-weight:600; color:#475569; margin-bottom:0.5rem;">N° da Solicitação (ID)</label>
                                        <input id="edit-numero" type="text" value="${e.numero || ''}" style="width:100%; padding:0.625rem 0.875rem; border:2px solid #e2e8f0; border-radius:0.5rem;" />
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:0.75rem; font-weight:600; color:#475569; margin-bottom:0.5rem;">Setor Responsável</label>
                                        <select id="edit-solicitante" style="width:100%; padding:0.625rem 0.875rem; border:2px solid #e2e8f0; border-radius:0.5rem; background:#f8fafc;">
                                            ${options.map(opt => `<option ${e.solicitante===opt?'selected':''} value="${opt}">${opt}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:0.75rem; font-weight:600; color:#475569; margin-bottom:0.5rem;">Descrição</label>
                                        <input id="edit-descricao" type="text" value="${e.descricao || ''}" style="width:100%; padding:0.625rem 0.875rem; border:2px solid #e2e8f0; border-radius:0.5rem;" />
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:0.75rem; font-weight:600; color:#475569; margin-bottom:0.5rem;">Fornecedor</label>
                                        <input id="edit-fornecedor" type="text" value="${e.fornecedor || ''}" style="width:100%; padding:0.625rem 0.875rem; border:2px solid #e2e8f0; border-radius:0.5rem;" />
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:0.75rem; font-weight:600; color:#475569; margin-bottom:0.5rem;">Quantidade</label>
                                        <input id="edit-quantidade" type="number" min="1" value="${e.quantidade ?? ''}" style="width:100%; padding:0.625rem 0.875rem; border:2px solid #e2e8f0; border-radius:0.5rem;" />
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:0.75rem; font-weight:600; color:#475569; margin-bottom:0.5rem;">Valor Estimado (R$)</label>
                                        <input id="edit-valor" type="number" step="0.01" min="0" value="${e.valor ?? ''}" style="width:100%; padding:0.625rem 0.875rem; border:2px solid #e2e8f0; border-radius:0.5rem;" />
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:0.75rem; font-weight:600; color:#475569; margin-bottom:0.5rem;">Observações</label>
                                        <textarea id="edit-observacoes" rows="3" style="width:100%; padding:0.625rem 0.875rem; border:2px solid #e2e8f0; border-radius:0.5rem;">${e.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                <div style="display:flex; gap:0.75rem; margin-top:1rem;">
                                    <button onclick="window.gestaoComprasApp.cancelEdit()" style="flex:1; padding:0.625rem 1.25rem; background:#e5e7eb; border:2px solid #cbd5e1; border-radius:0.5rem; color:#374151; font-weight:600;">Cancelar</button>
                                    <button onclick="window.gestaoComprasApp.saveEdit()" style="flex:1; padding:0.625rem 1.25rem; background:#2563eb; color:#fff; border:none; border-radius:0.5rem; font-weight:600; box-shadow:0 4px 12px rgba(37,99,235,0.3);">Salvar Alterações</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }
            }

            async handleCreateOrder() {
                const numeroManual = (document.getElementById('modal-numero')?.value || '').trim();
                const solicitante = document.getElementById('modal-solicitante')?.value || 'Qualidade';
                const descricao = document.getElementById('modal-descricao').value;
                const fornecedor = document.getElementById('modal-fornecedor').value;
                const valor = document.getElementById('modal-valor').value;
                const quantidade = document.getElementById('modal-quantidade')?.value;
                const observacoes = document.getElementById('modal-observacoes').value;

                if (!descricao || !fornecedor || !valor || !quantidade) {
                    alert('Por favor, preencha todos os campos obrigatórios');
                    return;
                }
                
                const order = {
                    numero: numeroManual || this.generateOrderNumber(),
                    descricao: descricao,
                    fornecedor: fornecedor,
                    valor: parseFloat(valor),
                    quantidade: parseInt(quantidade, 10),
                    observacoes: observacoes,
                    status: 'AGUARDANDO_APROVACAO_SC',
                    solicitante: solicitante
                };

                try {
                    console.log('💾 Salvando pedido:', order);
                    // Tentar salvar na API consolidada
                    const response = await fetch('/api/compras', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(order)
                    });

                    console.log('📡 Resposta da API (criar):', response.status, response.statusText);
                    if (response.ok) {
                        console.log('✅ Pedido salvo na API com sucesso');
                        // Recarregar pedidos da API
                        await this.loadOrders();
                        this.filterOrders(); // Atualiza a lista filtrada
                    } else {
                        console.log('❌ Erro ao salvar na API, usando localStorage');
                        // Fallback para localStorage
                        this.orders = [order, ...this.orders];
                        this.saveOrders();
                        this.filterOrders(); // Atualiza a lista filtrada
                    }
                    this.populateStatusFilter();
                    this.updateStats();
                    this.closeModals();
                    this.newOrder = { descricao: '', fornecedor: '', valor: '', observacoes: '' };
                } catch (error) {
                    console.error('Erro ao criar pedido na API, salvando localmente:', error);
                    // Fallback para localStorage em caso de erro
                    this.orders = [order, ...this.orders];
                    this.saveOrders();
                    this.filterOrders();
                    this.populateStatusFilter();
                    this.updateStats();
                    this.closeModals();
                    this.newOrder = { descricao: '', fornecedor: '', valor: '', observacoes: '' };
                }
            }

            generateOrderNumber() {
                if (this.orders.length === 0) {
                    return 'SC-001';
                }
                
                // Extrair números dos códigos existentes
                const numbers = this.orders
                    .map(o => {
                        const match = o.numero?.match(/SC-(\d+)/);
                        return match ? parseInt(match[1]) : 0;
                    })
                    .filter(n => n > 0);
                
                if (numbers.length === 0) {
                    return 'SC-001';
                }
                
                const nextNumber = Math.max(...numbers) + 1;
                return `SC-${nextNumber.toString().padStart(3, '0')}`;
            }

            async updateOrderStatus(order, newStatus, observacao = '') {
                try {
                    console.log('🔄 Atualizando status do pedido:', order.id, 'para:', newStatus);
                    
                    // Tentar atualizar na API consolidada
                    const response = await fetch(`/api/compras?id=${order.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            newStatus: newStatus
                        })
                    });

                    if (response.ok) {
                        console.log('✅ Status atualizado com sucesso');
                        // Não recarregar tudo, apenas atualizar filteredOrders
                        this.filterOrders();
                    } else {
                        // Fallback para localStorage
                        const updatedOrder = {
                            ...order,
                            status: newStatus,
                            historico: [
                                ...order.historico,
                                {
                                    data: new Date().toISOString(),
                                    status: newStatus,
                                    observacao: observacao || `Status alterado para ${this.STATUSES[newStatus].label}`
                                }
                            ]
                        };
                        this.orders = this.orders.map(o => o.numero === order.numero ? updatedOrder : o);
                        this.saveOrders();
                        this.filterOrders();
                    }
                    this.populateStatusFilter();
                    this.updateStats();
                    this.closeModals();
                } catch (error) {
                    console.error('Erro ao atualizar status na API, salvando localmente:', error);
                    // Fallback para localStorage em caso de erro
                    const updatedOrder = {
                        ...order,
                        status: newStatus,
                        historico: [
                            ...order.historico,
                            {
                                data: new Date().toISOString(),
                                status: newStatus,
                                observacao: observacao || `Status alterado para ${this.STATUSES[newStatus].label}`
                            }
                        ]
                    };
                    this.orders = this.orders.map(o => o.numero === order.numero ? updatedOrder : o);
                    this.saveOrders();
                    this.filterOrders();
                    this.populateStatusFilter();
                    this.updateStats();
                    this.closeModals();
                }
            }

            getNextStatus(currentStatus) {
                const statusFlow = {
                    // Fluxo completo (9 etapas)
                    'AGUARDANDO_APROVACAO_SC': 'SC_APROVADA',
                    'SC_APROVADA': 'AGUARDANDO_APROVACAO_OC',
                    'AGUARDANDO_APROVACAO_OC': 'OC_APROVADA',
                    'OC_APROVADA': 'PEDIDO_EMITIDO',
                    'PEDIDO_EMITIDO': 'AGUARDANDO_PAGAMENTO',
                    'AGUARDANDO_PAGAMENTO': 'PAGO',
                    'PAGO': 'AGUARDANDO_ENTREGA',
                    'AGUARDANDO_ENTREGA': 'ENTREGUE',
                    
                    // Status simplificados
                    'EM_ANALISE': 'APROVADO',
                    'AGUARDANDO_APROVACAO': 'APROVADO',
                    'APROVADO': 'CONCLUIDO'
                };
                return statusFlow[currentStatus];
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }

            // Funções de paginação
            renderPagination() {
                const pageNumbersContainer = document.getElementById('page-numbers');
                if (!pageNumbersContainer) return;

                pageNumbersContainer.innerHTML = '';

                for (let i = 1; i <= this.totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === this.currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => this.goToPage(i);
                    pageNumbersContainer.appendChild(pageBtn);
                }

                // Atualizar estado dos botões de navegação
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                
                if (prevBtn) {
                    prevBtn.disabled = this.currentPage === 1;
                }
                if (nextBtn) {
                    nextBtn.disabled = this.currentPage === this.totalPages;
                }
            }

            goToPage(page) {
                if (page < 1 || page > this.totalPages) return;
                this.currentPage = page;
                this.renderOrders();
            }

            previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.renderOrders();
                }
            }

            nextPage() {
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                    this.renderOrders();
                }
            }
        }

        // Inicializar o app quando a página carregar
        let gestaoComprasApp;
        document.addEventListener('DOMContentLoaded', () => {
            gestaoComprasApp = new GestaoComprasApp();
            // Tornar global para acesso nos modals
            window.gestaoComprasApp = gestaoComprasApp;
        });
    </script>
</body>
</html>
