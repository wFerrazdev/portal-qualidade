<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras | Portal da Qualidade</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="style.css">
    <script src="auth0-config.js"></script>
</head>
<body class="unauthenticated compras-page">
    <div class="page-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="GT Branco - Transparente.png" alt="GT Logo" class="sidebar-logo-img">
                <h2>Portal da Qualidade</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                        <span>Dashboard</span>
                    </a></li>
                    <li><a href="projetos.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Projetos</span>
                    </a></li>
                    <li><a href="reunioes.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>Reuniões</span>
                    </a></li>
                    <li><a href="auditoriasevisitas.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>Auditorias</span>
                    </a></li>
                    <li><a href="calibracao.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Calibração</span>
                    </a></li>
                    <li><a href="compras.html" class="nav-item active">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                        <span>Compras</span>
                    </a></li>
                    <li><a href="login.html" class="nav-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span>Sair</span>
                    </a></li>
                </ul>
            </nav>
            <div class="user-info">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span>Logado como: Will</span>
            </div>
            <div class="sidebar-footer-logo">
                <img src="logo.png" alt="Logo" class="footer-logo">
            </div>
        </aside>

        <div class="overlay" id="overlay"></div>

        <!-- <div class="main-content"> -->
            <header class="content-header">
                <!-- Ondas animadas integradas no content-header -->
                <svg class="projects-wave wave-1" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q100,20 200,100 Q300,180 400,100 Q500,20 600,100 Q700,180 800,100 Q900,20 1000,100 Q1100,180 1200,100" stroke="#60a5fa" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-2" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q150,30 300,100 Q450,170 600,100 Q750,30 900,100 Q1050,170 1200,100" stroke="#93c5fd" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-3" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q200,40 400,100 Q600,160 800,100 Q1000,40 1200,100" stroke="#3b82f6" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-4" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q120,10 240,100 Q360,190 480,100 Q600,10 720,100 Q840,190 960,100 Q1080,10 1200,100" stroke="#1d4ed8" stroke-width="2" fill="none" />
                    </svg>
                <svg class="projects-wave wave-5" viewBox="0 0 1200 200" preserveAspectRatio="none">
                        <path d="M0,100 Q180,50 360,100 Q540,150 720,100 Q900,50 1080,100 Q1200,100 1200,100" stroke="#0ea5e9" stroke-width="2" fill="none" />
                    </svg>

                <!-- Partículas flutuantes integradas no content-header. -->
                <div class="projects-particle straight" style="top: 100%; left: 10%; animation-delay: 0s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 80%; animation-delay: 0.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 20%; animation-delay: 1s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 90%; animation-delay: 1.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 30%; animation-delay: 2s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 70%; animation-delay: 2.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 40%; animation-delay: 3s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 60%; animation-delay: 3.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 50%; animation-delay: 4s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 15%; animation-delay: 4.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 85%; animation-delay: 5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 25%; animation-delay: 5.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 75%; animation-delay: 6s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 35%; animation-delay: 6.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 65%; animation-delay: 7s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 45%; animation-delay: 7.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 55%; animation-delay: 8s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 5%; animation-delay: 8.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 95%; animation-delay: 9s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 12%; animation-delay: 9.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 88%; animation-delay: 10s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 22%; animation-delay: 10.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 78%; animation-delay: 11s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 32%; animation-delay: 11.5s;"></div>
                <div class="projects-particle straight" style="top: 100%; left: 68%; animation-delay: 12s;"></div>
                
                <div class="projects-header">
                    <div class="header-left">
                        <h1 class="projects-title">Compras</h1>
                        <p class="projects-subtitle">Sistema de gestão de pedidos e solicitações de compra</p>
                    </div>
                </div>
            </header>

            <main class="content-area">
                <!-- Sistema de Gestão de Compras -->
                <div id="gestao-compras-app" class="gestao-compras-container">
                    <!-- Loading state -->
                    <div id="loading-state" class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Carregando sistema de gestão...</p>
                </div>
                    
                    <!-- Main App Content (hidden initially) -->
                    <div id="app-content" class="app-content" style="display: none;">
                        <!-- Header -->
                        <div class="app-header">
                    <div class="header-left">
                                <h1 class="app-title">Pedidos de Compra</h1>
                                <p class="app-subtitle">Gerencie solicitações e acompanhe o fluxo completo</p>
                    </div>
                            <button id="nova-solicitacao-btn" class="btn-nova-solicitacao">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                                Nova Solicitação
                        </button>
                        </div>

                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Total de Pedidos</p>
                                        <p class="stat-value" id="total-pedidos">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                        </svg>
                                    </div>
                    </div>
                </div>

                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Aguardando</p>
                                        <p class="stat-value" id="aguardando-count">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12,6 12,12 16,14"></polyline>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Em Andamento</p>
                                        <p class="stat-value" id="andamento-count">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"></polyline>
                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-content">
                                    <div class="stat-info">
                                        <p class="stat-label">Concluídos</p>
                                        <p class="stat-value" id="concluidos-count">0</p>
                                    </div>
                                    <div class="stat-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22,4 12,14.01 9,11.01"></polyline>
                                </svg>
                                    </div>
                        </div>
                    </div>
                </div>

                        <!-- Filters -->
                        <div class="filters-section">
                            <div class="search-container">
                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                                <input type="text" id="search-input" placeholder="Buscar por número, descrição ou fornecedor..." class="search-input">
                            </div>
                            <div class="filter-container">
                                <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"></polygon>
                                </svg>
                                <select id="status-filter" class="status-filter">
                                    <option value="TODOS">Todos os Status</option>
                                </select>
                            </div>
        </div>

                        <!-- Orders Table -->
                        <div class="orders-table-container">
                            <table class="orders-table">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Descrição</th>
                                        <th>Fornecedor</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-tbody">
                                    <!-- Orders will be populated here -->
                                </tbody>
                            </table>
                            <div id="empty-state" class="empty-state" style="display: none;">
                                <div class="empty-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                    </svg>
                                </div>
                                <p>Nenhum pedido encontrado</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

        <footer class="footer">
            <p>&copy; 2025 - Developed by William Ferraz</p>
        </footer>
        <!-- </div> -->
    </div>

    <script type="module">
        // Função ajudante para fazer chamadas autenticadas
        async function authFetch(url, options = {}) {
            // Usar a função authenticatedFetch do auth0-config.js
            return await authenticatedFetch(url, options);
        }
        // A verificação de autenticação é feita automaticamente pelo auth0-config.js

        // --- LÓGICA PARA EXIBIR NOME DO USUÁRIO ---
        // Exibir informações do usuário autenticado via Auth0
        checkAuth().then(user => {
            if (user) {
                const userInfoSpan = document.querySelector('.user-info span');
                const userName = user.name || user.email;
                if (userInfoSpan) {
                    userInfoSpan.innerHTML = `Logado como: <strong>${userName}</strong>`;
                }
            }
        }).catch(error => {
            console.error('Erro ao obter informações do usuário:', error);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // --- LÓGICA DO MENU ---
            const body = document.body;
            const sidebar = document.querySelector('.sidebar');
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const overlay = document.getElementById('overlay');
            function openMenu() { body.classList.add('menu-open'); sidebar.classList.add('mobile-nav-open'); overlay.classList.add('active'); }
            function closeMenu() { body.classList.remove('menu-open'); sidebar.classList.remove('mobile-nav-open'); overlay.classList.remove('active'); }
            if (mobileMenuButton) { mobileMenuButton.addEventListener('click', openMenu); }
            if (overlay) { overlay.addEventListener('click', closeMenu); }
            window.addEventListener('load', () => { if (sidebar) { sidebar.classList.remove('preload'); } });
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => { 
                    e.preventDefault();
                    logout(); // Função definida em auth0-config.js
                });
            }
            
            // --- LÓGICA DE PERMISSÕES (VISUAL) ---
            // Verificar permissões do usuário autenticado
            checkAuth().then(user => {
                if (user) {
                    // Aqui você pode implementar lógica de permissões baseada no Auth0
                    // Por exemplo, verificar roles ou claims do usuário
                    const userRoles = user['https://portalqualidade.com/roles'] || [];
                    // Se o usuário NÃO tiver a permissão 'admin' na sua lista de permissões...
                    if (!userRoles.includes('admin')) {
                        // ...encontra e esconde todos os botões de ação.
                        const addBtn = document.querySelector('.add-button');
                        if (addBtn) addBtn.style.display = 'none';

                        // Também esconde os botões de editar/excluir que são criados dinamicamente
                        // Adicionando uma classe ao container principal para o CSS esconder os botões
                        const grid = document.querySelector('.projects-grid, .audits-grid, .meetings-list');
                        if(grid) grid.classList.add('viewer-mode');
                    }
                }
            }).catch(error => {
                console.error('Erro ao verificar permissões:', error);
            });
            

        });

        // --- LÓGICA DO MENU LATERAL ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                
                if (mobileMenuButton) {
                    mobileMenuButton.classList.toggle('active');
                }
            }
        }

        // Event listeners para o menu lateral..
        const mobileMenuButton = document.getElementById('mobileMenuButton');
            const overlay = document.getElementById('overlay');

            if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', toggleSidebar);
        }
        
        if (overlay) {
            overlay.addEventListener('click', toggleSidebar);
        }

        // --- SISTEMA DE GESTÃO DE COMPRAS ---
        class GestaoComprasApp {
            constructor() {
                this.orders = [];
                this.filteredOrders = [];
                this.searchTerm = '';
                this.statusFilter = 'TODOS';
                this.showModal = false;
                this.showDetailModal = false;
                this.selectedOrder = null;
                this.newOrder = {
                    descricao: '',
                    fornecedor: '',
                    valor: '',
                    observacoes: ''
                };

                this.STATUSES = {
                    AGUARDANDO_APROVACAO_SC: { label: 'Aguardando Aprovação SC', color: 'bg-amber-50 text-amber-700 border-amber-200' },
                    SC_APROVADA: { label: 'SC Aprovada', color: 'bg-blue-50 text-blue-700 border-blue-200' },
                    AGUARDANDO_APROVACAO_OC: { label: 'Aguardando Aprovação OC', color: 'bg-orange-50 text-orange-700 border-orange-200' },
                    OC_APROVADA: { label: 'OC Aprovada', color: 'bg-purple-50 text-purple-700 border-purple-200' },
                    PEDIDO_EMITIDO: { label: 'Pedido Emitido', color: 'bg-indigo-50 text-indigo-700 border-indigo-200' },
                    AGUARDANDO_PAGAMENTO: { label: 'Aguardando Pagamento', color: 'bg-pink-50 text-pink-700 border-pink-200' },
                    PAGO: { label: 'Pago', color: 'bg-cyan-50 text-cyan-700 border-cyan-200' },
                    AGUARDANDO_ENTREGA: { label: 'Aguardando Entrega', color: 'bg-teal-50 text-teal-700 border-teal-200' },
                    ENTREGUE: { label: 'Entregue', color: 'bg-emerald-50 text-emerald-700 border-emerald-200' },
                    CANCELADO: { label: 'Cancelado', color: 'bg-red-50 text-red-700 border-red-200' }
                };

                this.init();
            }

            async init() {
                try {
                    await this.loadOrders();
                    this.setupEventListeners();
                    this.populateStatusFilter();
                    this.updateStats();
                    this.renderOrders();
                    this.hideLoading();
                } catch (error) {
                    console.error('Erro ao inicializar app:', error);
                    this.hideLoading();
                }
            }

            hideLoading() {
                const loadingState = document.getElementById('loading-state');
                const appContent = document.getElementById('app-content');
                if (loadingState) loadingState.style.display = 'none';
                if (appContent) appContent.style.display = 'block';
            }

            async loadOrders() {
                try {
                    // Simular carregamento de dados (você pode integrar com sua API aqui)
                    const storedOrders = localStorage.getItem('gestao-compras-orders');
                    if (storedOrders) {
                        this.orders = JSON.parse(storedOrders);
                    } else {
                        // Dados de exemplo
                        this.orders = [
                            {
                                numero: 1001,
                                descricao: 'Equipamentos de laboratório',
                                fornecedor: 'LabTech Solutions',
                                valor: 15000.00,
                                status: 'AGUARDANDO_APROVACAO_SC',
                                dataCriacao: new Date().toISOString(),
                                observacoes: 'Equipamentos para novo laboratório',
                                historico: [{
                                    data: new Date().toISOString(),
                                    status: 'AGUARDANDO_APROVACAO_SC',
                                    observacao: 'Solicitação de compra criada pelo setor de Qualidade'
                                }]
                            },
                            {
                                numero: 1002,
                                descricao: 'Material de consumo',
                                fornecedor: 'SupplyCorp',
                                valor: 2500.00,
                                status: 'SC_APROVADA',
                                dataCriacao: new Date(Date.now() - 86400000).toISOString(),
                                observacoes: 'Material para testes de qualidade',
                                historico: [
                                    {
                                        data: new Date(Date.now() - 86400000).toISOString(),
                                        status: 'AGUARDANDO_APROVACAO_SC',
                                        observacao: 'Solicitação de compra criada pelo setor de Qualidade'
                                    },
                                    {
                                        data: new Date().toISOString(),
                                        status: 'SC_APROVADA',
                                        observacao: 'Aprovado pelo Supervisor de Compras'
                                    }
                                ]
                            }
                        ];
                        this.saveOrders();
                    }
                    this.filteredOrders = [...this.orders];
                } catch (error) {
                    console.error('Erro ao carregar pedidos:', error);
                    this.orders = [];
                    this.filteredOrders = [];
                }
            }

            saveOrders() {
                localStorage.setItem('gestao-compras-orders', JSON.stringify(this.orders));
            }

            setupEventListeners() {
                // Nova solicitação
                const novaSolicitacaoBtn = document.getElementById('nova-solicitacao-btn');
                if (novaSolicitacaoBtn) {
                    novaSolicitacaoBtn.addEventListener('click', () => this.showCreateModal());
                }

                // Search
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value;
                        this.filterOrders();
                    });
                }

                // Status filter
                const statusFilter = document.getElementById('status-filter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', (e) => {
                        this.statusFilter = e.target.value;
                        this.filterOrders();
                    });
                }
            }

            populateStatusFilter() {
                const statusFilter = document.getElementById('status-filter');
                if (!statusFilter) return;

                // Limpar opções existentes (exceto "Todos os Status")
                while (statusFilter.children.length > 1) {
                    statusFilter.removeChild(statusFilter.lastChild);
                }

                // Adicionar opções de status
                Object.keys(this.STATUSES).forEach(status => {
                    const count = this.orders.filter(o => o.status === status).length;
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = `${this.STATUSES[status].label} (${count})`;
                    statusFilter.appendChild(option);
                });
            }

            filterOrders() {
                let filtered = [...this.orders];

                if (this.searchTerm) {
                    filtered = filtered.filter(order => 
                        order.numero.toString().includes(this.searchTerm) ||
                        order.descricao.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        order.fornecedor.toLowerCase().includes(this.searchTerm.toLowerCase())
                    );
                }

                if (this.statusFilter !== 'TODOS') {
                    filtered = filtered.filter(order => order.status === this.statusFilter);
                }

                this.filteredOrders = filtered;
                this.renderOrders();
            }

            updateStats() {
                const totalPedidos = document.getElementById('total-pedidos');
                const aguardandoCount = document.getElementById('aguardando-count');
                const andamentoCount = document.getElementById('andamento-count');
                const concluidosCount = document.getElementById('concluidos-count');

                if (totalPedidos) totalPedidos.textContent = this.orders.length;

                const aguardando = this.orders.filter(o => 
                    o.status === 'AGUARDANDO_APROVACAO_SC' || o.status === 'AGUARDANDO_APROVACAO_OC'
                ).length;
                if (aguardandoCount) aguardandoCount.textContent = aguardando;

                const andamento = this.orders.filter(o => 
                    ['SC_APROVADA', 'OC_APROVADA', 'PEDIDO_EMITIDO', 'AGUARDANDO_PAGAMENTO', 'PAGO', 'AGUARDANDO_ENTREGA'].includes(o.status)
                ).length;
                if (andamentoCount) andamentoCount.textContent = andamento;

                const concluidos = this.orders.filter(o => o.status === 'ENTREGUE').length;
                if (concluidosCount) concluidosCount.textContent = concluidos;
            }

            renderOrders() {
                const tbody = document.getElementById('orders-tbody');
                const emptyState = document.getElementById('empty-state');
                
                if (!tbody) return;

                tbody.innerHTML = '';

                if (this.filteredOrders.length === 0) {
                    if (emptyState) emptyState.style.display = 'block';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';

                this.filteredOrders.forEach((order, idx) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gradient-to-r hover:from-blue-50/50 hover:to-indigo-50/30 transition-all duration-200';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white text-xs font-bold">
                                    ${idx + 1}
                                </div>
                                <span class="font-bold text-gray-900">#${order.numero}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 font-medium max-w-xs truncate">${order.descricao}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-700">${order.fornecedor}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                                ${this.formatCurrency(order.valor)}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-${order.status}">
                                ${this.STATUSES[order.status].label}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            ${this.formatDate(order.dataCriacao)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="window.gestaoComprasApp.showDetailModal(${order.numero})" class="text-blue-600 hover:text-indigo-600 flex items-center gap-1.5 text-sm font-semibold group">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                <span>Ver</span>
                                <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            showCreateModal() {
                this.showModal = true;
                this.renderModals();
            }

            showDetailModal(orderNumber) {
                const order = this.orders.find(o => o.numero === orderNumber);
                if (!order) return;

                this.selectedOrder = order;
                this.showDetailModal = true;
                this.renderModals();
            }

            closeModals() {
                this.showModal = false;
                this.showDetailModal = false;
                this.renderModals();
            }

            renderModals() {
                // Remove modals existentes
                const existingModals = document.querySelectorAll('.modal-overlay');
                existingModals.forEach(modal => modal.remove());

                // Modal de criação
                if (this.showModal) {
                    const modalHTML = `
                        <div class="modal-overlay" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem;">
                            <div class="modal-content" style="background: white; border-radius: 1rem; max-width: 32rem; width: 100%; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                                <div style="margin-bottom: 1.5rem;">
                                    <h2 style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #6366f1 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 0.25rem 0;">
                                        Nova Solicitação de Compra
                                    </h2>
                                    <p style="font-size: 0.875rem; color: #64748b; margin: 0;">Preencha os dados para criar uma nova solicitação</p>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Descrição do Item/Serviço *
                                        </label>
                                        <input type="text" id="modal-descricao" value="${this.newOrder.descricao}" 
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="Ex: Material de laboratório, equipamento, etc.">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Fornecedor *
                                        </label>
                                        <input type="text" id="modal-fornecedor" value="${this.newOrder.fornecedor}" 
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="Nome do fornecedor">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Valor Estimado (R$) *
                                        </label>
                                        <input type="number" id="modal-valor" value="${this.newOrder.valor}" step="0.01" min="0"
                                               style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease;"
                                               placeholder="0.00">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                            Observações
                                        </label>
                                        <textarea id="modal-observacoes" rows="3" 
                                                  style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.3s ease; resize: vertical;"
                                                  placeholder="Informações adicionais...">${this.newOrder.observacoes}</textarea>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                    <button onclick="window.gestaoComprasApp.handleCreateOrder()" 
                                            style="flex: 1; background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);">
                                        Criar Solicitação
                                    </button>
                                    <button onclick="window.gestaoComprasApp.closeModals()" 
                                            style="flex: 1; background: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }

                // Modal de detalhes
                if (this.showDetailModal && this.selectedOrder) {
                    const order = this.selectedOrder;
                    const modalHTML = `
                        <div class="modal-overlay" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; overflow-y: auto;">
                            <div class="modal-content" style="background: white; border-radius: 1rem; max-width: 80rem; width: 100%; padding: 2rem; margin: 2rem 0; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                                    <div>
                                        <h2 style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #6366f1 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 0.75rem 0;">
                                            Pedido #${order.numero}
                                        </h2>
                                        <span style="display: inline-block; padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 600; border: 2px solid; ${this.STATUSES[order.status].color.replace('bg-', 'background-color: ').replace('text-', 'color: ').replace('border-', 'border-color: ')}">
                                            ${this.STATUSES[order.status].label}
                                        </span>
                                    </div>
                                    <button onclick="window.gestaoComprasApp.closeModals()" 
                                            style="color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: all 0.3s ease;">
                                        <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); padding: 1.5rem; border-radius: 1rem; border: 2px solid #bfdbfe;">
                                        <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #3b82f6;">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                            </svg>
                                            Informações do Pedido
                                        </h3>
                                        <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.875rem;">
                                            <div>
                                                <span style="color: #6b7280; display: block; margin-bottom: 0.25rem; font-weight: 500;">Descrição:</span>
                                                <p style="font-weight: 600; color: #1f2937; margin: 0;">${order.descricao}</p>
                                            </div>
                                            <div>
                                                <span style="color: #6b7280; display: block; margin-bottom: 0.25rem; font-weight: 500;">Fornecedor:</span>
                                                <p style="font-weight: 600; color: #1f2937; margin: 0;">${order.fornecedor}</p>
                                            </div>
                                            <div>
                                                <span style="color: #6b7280; display: block; margin-bottom: 0.25rem; font-weight: 500;">Valor:</span>
                                                <p style="font-weight: 700; font-size: 1.25rem; background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                                                    ${this.formatCurrency(order.valor)}
                                                </p>
                                            </div>
                                            <div>
                                                <span style="color: #6b7280; display: block; margin-bottom: 0.25rem; font-weight: 500;">Data de Criação:</span>
                                                <p style="font-weight: 600; color: #1f2937; margin: 0;">${this.formatDate(order.dataCriacao)}</p>
                                            </div>
                                            ${order.observacoes ? `
                                                <div>
                                                    <span style="color: #6b7280; display: block; margin-bottom: 0.25rem; font-weight: 500;">Observações:</span>
                                                    <p style="font-weight: 600; color: #1f2937; margin: 0;">${order.observacoes}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>

                                    <div>
                                        <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 1rem; font-size: 1rem;">Ações Rápidas</h3>
                                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                            ${order.status !== 'ENTREGUE' && order.status !== 'CANCELADO' && this.getNextStatus(order.status) ? `
                                                <button onclick="window.gestaoComprasApp.updateOrderStatus(window.gestaoComprasApp.selectedOrder, '${this.getNextStatus(order.status)}')" 
                                                        style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.25rem; border-radius: 0.75rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);">
                                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                    Avançar: ${this.STATUSES[this.getNextStatus(order.status)].label}
                                                </button>
                                            ` : ''}
                                            ${order.status !== 'CANCELADO' && order.status !== 'ENTREGUE' ? `
                                                <button onclick="window.gestaoComprasApp.updateOrderStatus(window.gestaoComprasApp.selectedOrder, 'CANCELADO', 'Pedido cancelado')" 
                                                        style="width: 100%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 1.25rem; border-radius: 0.75rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);">
                                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                    Cancelar Pedido
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>

                                <div style="background: linear-gradient(135deg, #f9fafb 0%, #dbeafe 100%); padding: 1.5rem; border-radius: 1rem; border: 1px solid #e5e7eb;">
                                    <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 1.25rem; font-size: 1rem;">Histórico do Pedido</h3>
                                    <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 20rem; overflow-y: auto; padding-right: 0.5rem;">
                                        ${order.historico.slice().reverse().map((item, index) => `
                                            <div style="display: flex; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; ${index === order.historico.length - 1 ? 'border-bottom: none;' : ''}">
                                                <div style="flex-shrink: 0;">
                                                    <div style="width: 2.75rem; height: 2.75rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; border: 2px solid; ${this.STATUSES[item.status].color.replace('bg-', 'background-color: ').replace('text-', 'color: ').replace('border-', 'border-color: ')} box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                                                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem;">
                                                        <div style="min-width: 0; flex: 1;">
                                                            <p style="font-weight: 700; color: #1f2937; font-size: 0.875rem; margin: 0;">${this.STATUSES[item.status].label}</p>
                                                            <p style="font-size: 0.75rem; color: #6b7280; margin: 0.25rem 0 0 0;">${item.observacao}</p>
                                                        </div>
                                                        <span style="font-size: 0.75rem; color: #9ca3af; white-space: nowrap;">${this.formatDate(item.data)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
                                    <button onclick="window.gestaoComprasApp.closeModals()" 
                                            style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); color: #374151; padding: 0.625rem 1.5rem; border-radius: 0.75rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                        Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }
            }

            handleCreateOrder() {
                const descricao = document.getElementById('modal-descricao').value;
                const fornecedor = document.getElementById('modal-fornecedor').value;
                const valor = document.getElementById('modal-valor').value;
                const observacoes = document.getElementById('modal-observacoes').value;

                if (!descricao || !fornecedor || !valor) {
                    alert('Por favor, preencha todos os campos obrigatórios');
                    return;
                }
                
                const order = {
                    numero: this.generateOrderNumber(),
                    descricao: descricao,
                    fornecedor: fornecedor,
                    valor: parseFloat(valor),
                    observacoes: observacoes,
                    status: 'AGUARDANDO_APROVACAO_SC',
                    dataCriacao: new Date().toISOString(),
                    historico: [{
                        data: new Date().toISOString(),
                        status: 'AGUARDANDO_APROVACAO_SC',
                        observacao: 'Solicitação de compra criada pelo setor de Qualidade'
                    }]
                };

                try {
                    this.orders = [order, ...this.orders];
                    this.saveOrders();
                    this.populateStatusFilter();
                    this.updateStats();
                    this.renderOrders();
                    this.closeModals();
                    this.newOrder = { descricao: '', fornecedor: '', valor: '', observacoes: '' };
                } catch (error) {
                    alert('Erro ao criar pedido');
                }
            }

            generateOrderNumber() {
                return this.orders.length > 0 ? Math.max(...this.orders.map(o => o.numero)) + 1 : 1001;
            }

            updateOrderStatus(order, newStatus, observacao = '') {
                const updatedOrder = {
                    ...order,
                    status: newStatus,
                    historico: [
                        ...order.historico,
                        {
                            data: new Date().toISOString(),
                            status: newStatus,
                            observacao: observacao || `Status alterado para ${this.STATUSES[newStatus].label}`
                        }
                    ]
                };

                try {
                    this.orders = this.orders.map(o => o.numero === order.numero ? updatedOrder : o);
                    this.saveOrders();
                    this.populateStatusFilter();
                    this.updateStats();
                    this.renderOrders();
                    this.closeModals();
                } catch (error) {
                    alert('Erro ao atualizar status');
                }
            }

            getNextStatus(currentStatus) {
                const statusFlow = {
                    'AGUARDANDO_APROVACAO_SC': 'SC_APROVADA',
                    'SC_APROVADA': 'AGUARDANDO_APROVACAO_OC',
                    'AGUARDANDO_APROVACAO_OC': 'OC_APROVADA',
                    'OC_APROVADA': 'PEDIDO_EMITIDO',
                    'PEDIDO_EMITIDO': 'AGUARDANDO_PAGAMENTO',
                    'AGUARDANDO_PAGAMENTO': 'PAGO',
                    'PAGO': 'AGUARDANDO_ENTREGA',
                    'AGUARDANDO_ENTREGA': 'ENTREGUE'
                };
                return statusFlow[currentStatus];
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }
        }

        // Inicializar o app quando a página carregar
        let gestaoComprasApp;
        document.addEventListener('DOMContentLoaded', () => {
            gestaoComprasApp = new GestaoComprasApp();
            // Tornar global para acesso nos modals
            window.gestaoComprasApp = gestaoComprasApp;
        });
    </script>
</body>
</html>
